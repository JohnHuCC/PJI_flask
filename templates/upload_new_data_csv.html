<!DOCTYPE html>
<html lang="en">
<head>
    <title>Upload New Data</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Upload New Data" />
    <meta name="author" content="" />
    <link href="/static/css/styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="static/assets/img/nycu_logo.png" />
    <style>
        :root {
            --upload-bg-1: #e9f2ff;
            --upload-bg-2: #f6f9ff;
            --upload-border: #d6e0ef;
            --upload-accent: #0e60c9;
            --upload-text: #223042;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(145deg, var(--upload-bg-1) 0%, var(--upload-bg-2) 56%, #ffffff 100%);
        }

        .upload-shell {
            max-width: 760px;
            margin: 2.2rem auto;
            border-radius: 16px;
            border: 1px solid var(--upload-border);
            background: #fff;
            box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
            overflow: hidden;
        }

        .upload-header {
            background: linear-gradient(120deg, #0e60c9, #1890d8);
            color: #fff;
            padding: 1.2rem 1.3rem;
        }

        .upload-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .upload-header p {
            margin: 0.35rem 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .upload-body {
            padding: 1.2rem 1.3rem 1.4rem;
        }

        .file-box {
            border: 1px dashed #9eb8db;
            border-radius: 12px;
            background: #f9fbff;
            padding: 1rem;
        }

        .file-meta {
            margin-top: 0.75rem;
            color: #4b5563;
            font-size: 0.88rem;
        }

        .progress {
            height: 1.1rem;
            border-radius: 999px;
            border: 1px solid var(--upload-border);
            background: #edf2fb;
            overflow: hidden;
        }

        .progress-bar {
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.75rem;
            background: linear-gradient(90deg, #0e60c9, #20a2ea);
        }

        .status-box {
            margin-top: 0.85rem;
            border: 1px solid #e3e8f1;
            background: #fbfdff;
            border-radius: 10px;
            padding: 0.75rem;
        }

        .status-box .label {
            font-size: 0.78rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.35rem;
        }

        .status-box .content {
            color: var(--upload-text);
            font-size: 0.9rem;
            white-space: pre-line;
        }

        .btn-upload {
            border-radius: 999px;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            min-width: 130px;
        }

        .note-list {
            margin: 0;
            padding-left: 1rem;
            color: #4b5563;
            font-size: 0.84rem;
        }
    </style>
    <link href="/static/css/hospital-theme.css" rel="stylesheet" />
</head>

<body class="hospital-ui">
    <div class="upload-shell">
        <div class="upload-header">
            <h3>Upload New Data</h3>
            <p>Upload a CSV/XLSX file, validate required columns, then import to training pool.</p>
        </div>

        <div class="upload-body">
            <form>
                <div class="file-box">
                    <input type="file" id="csvFile" name="file" class="form-control-file" accept=".csv,.xlsx">
                    <div class="file-meta" id="fileMeta">No file selected.</div>
                </div>

                <div class="mt-3">
                    <div class="progress">
                        <div id="progress_bar_upload_new_data" class="progress-bar" style="width:0%">0%</div>
                    </div>
                </div>

                <div class="status-box">
                    <div class="label">Validation Status</div>
                    <div class="content" id="validationStatus">Select a file to begin validation.</div>
                </div>

                <div class="status-box">
                    <div class="label">Required Columns</div>
                    <ul class="note-list">
                        <li>No.Group</li>
                        <li>PJI/Revision Date</li>
                        <li>ASA, Age, Serum ESR, Serum WBC, Segment (%), HGB, PLATELET</li>
                        <li>Serum CRP, Positive Histology, 2X positive culture, Pulurence, Single Positive culture</li>
                        <li>Total CCI, Total Elixhauser Groups per record</li>
                    </ul>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary btn-upload" id="uploadButton" type="button">Upload</button>
                    <a class="btn btn-outline-secondary btn-upload" href="/train_new_data">Go To New Data</a>
                </div>
            </form>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    const requiredColumns = [
        'No.Group', 'PJI/Revision Date', 'ASA', 'Age',
        'Serum ESR', 'Serum WBC ', 'Segment (%)', 'HGB', 'PLATELET',
        'Serum CRP', 'Positive Histology',
        '2X positive culture', 'Pulurence', 'Single Positive culture', 'Total CCI',
        'Total Elixhauser Groups per record'
    ];

    function setStatus(text, isError) {
        const el = document.getElementById('validationStatus');
        el.textContent = text;
        el.style.color = isError ? '#b42318' : '#1f2937';
    }

    function setFileMeta(file) {
        const meta = document.getElementById('fileMeta');
        if (!file) {
            meta.textContent = 'No file selected.';
            return;
        }
        const kb = Math.round(file.size / 1024);
        meta.textContent = `Selected: ${file.name} (${kb} KB)`;
    }

    function normalizeHeaders(headers) {
        return headers.map(h => String(h || '').trim());
    }

    function validateColumns(sheetColumns) {
        const normalized = normalizeHeaders(sheetColumns);
        const missingColumns = requiredColumns.filter(col => !normalized.includes(col));
        if (missingColumns.length > 0) {
            setStatus(`Missing columns:\n- ${missingColumns.join('\n- ')}`, true);
            return false;
        }
        setStatus('Validation passed. Ready to upload.', false);
        return true;
    }

    $(document).ready(function() {
        const uploadBtn = $('#uploadButton');

        $('#csvFile').on('change', function() {
            const file = this.files[0];
            setFileMeta(file);
            if (!file) {
                setStatus('Select a file to begin validation.', false);
            }
        });

        uploadBtn.on('click', function(event) {
            event.preventDefault();
            const fileInput = $('#csvFile')[0];
            const file = fileInput.files[0];

            if (!file) {
                setStatus('Please choose a file before uploading.', true);
                return;
            }

            const fileName = file.name;
            const fileType = file.type;

            if (fileName.includes('#') || fileName.includes('&')) {
                setStatus('File name should not contain special characters like # or &.', true);
                return;
            }

            const maxFileSize = 1024 * 1024;
            if (file.size > maxFileSize) {
                setStatus('File size should not exceed 1 MB.', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let sheetColumns = [];

                if (fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet);
                    if (!sheetData.length) {
                        setStatus('Excel file is empty.', true);
                        return;
                    }
                    sheetColumns = Object.keys(sheetData[0]);
                } else if (fileType === 'text/csv' || fileName.toLowerCase().endsWith('.csv')) {
                    const lines = data.split('\n');
                    const headers = (lines[0] || '').split(',');
                    sheetColumns = headers;
                } else {
                    setStatus('Unsupported file type.', true);
                    return;
                }

                if (!validateColumns(sheetColumns)) {
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                uploadBtn.prop('disabled', true).text('Uploading...');

                $.ajax({
                    url: '/upload_new_data_csv',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        setStatus(String(response), false);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status === 400) {
                            try {
                                const errorData = JSON.parse(jqXHR.responseText);
                                setStatus(`Error: ${errorData.message}`, true);
                            } catch (_e) {
                                setStatus('Upload failed: bad request.', true);
                            }
                        } else {
                            setStatus(`Upload failed: ${errorThrown || textStatus}`, true);
                        }
                        uploadBtn.prop('disabled', false).text('Upload');
                    }
                });
            };

            if (fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || fileType === 'text/csv' || fileName.toLowerCase().endsWith('.csv')) {
                reader.readAsBinaryString(file);
            } else {
                setStatus('Unsupported file type.', true);
            }
        });
    });
</script>
<script>
    const socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('progress_percent', function(data) {
        const percentage = data.percentage;
        const bar = document.getElementById('progress_bar_upload_new_data');
        bar.style.width = percentage + '%';
        bar.innerText = percentage + '%';
    });
    socket.on('task_completed', function() {
        window.location.href = '/train_new_data';
    });
</script>
</body>
</html>
